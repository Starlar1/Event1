<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glory Event - Box ဖောက်ခြင်း</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            width: 100vw;
            height: 100vh;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            flex-direction: column;
            background: url("https://iili.io/KcFXTb9.gif") no-repeat center center fixed;
            background-size: cover;
        }

        /* Token Display */
        .token-display {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.5);
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            z-index: 10;
        }
        .token-display img {
            width: 25px;
            height: 25px;
        }

        /* Round Display */
        .round-display {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.5);
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            z-index: 10;
        }

        /* Home Buttons */
        .home-buttons {
            position: absolute;
            top: 50%;
            right: 5%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .home-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #0066ff, #3399ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        .home-btn:hover { transform: translateY(-2px); }

        /* Event Screen */
        #eventScreen {
            display: none;
            width: 100%;
            height: 100%;
            background: url("https://iili.io/KcQhXn4.jpg") no-repeat center center fixed;
            background-size: cover;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
        }
        
        /* 3x3 Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            width: 80%;
            max-width: 400px;
            aspect-ratio: 1/1;
            margin-bottom: 20px;
        }
        
        .grid-box {
            width: 100%;
            height: 100%;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
        }
        
        .grid-box:hover:not(.opened) {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .grid-box.opened {
            cursor: not-allowed;
            opacity: 0.8;
            transform: scale(0.95);
        }
        
        .grid-box img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
        
        .crack-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #0066ff, #3399ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            transition: transform 0.2s;
            margin-top: 20px;
        }
        .crack-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Back Button with Arrow Icon */
        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #0066ff, #3399ff);
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            transition: transform 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .back-button:hover { transform: scale(1.1); }
        .back-button svg { display: block; }

        /* Modal Base */
        .modal {
            display: none;
            position: fixed;
            top:0; left:0;
            width:100%; height:100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .modal h2 {
            margin-bottom: 15px;
            text-shadow: 0 0 5px black;
        }
        .modal img {
            border-radius: 8px;
            margin: 8px;
        }
        .close-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #0066ff, #3399ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .close-btn:hover { transform: scale(1.05); }

        /* Reward Modal Special */
        #rewardModal img {
            max-width: 120px;
            width: 100%;
        }
        
        /* Instructions */
        .instructions {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 5px black;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        /* Reset Button */
        .reset-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            background: linear-gradient(135deg, #ff3300, #ff6600);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .reset-btn:hover { transform: scale(1.05); }
        
        /* Progress Bar */
        .progress-container {
            width: 80%;
            max-width: 400px;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00cc00, #66ff66);
            width: 0%;
            transition: width 0.5s;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
            font-size: 18px;
        }
        
        .spinner {
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 5px solid #0066ff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Diamond Input Modal */
        .diamond-modal {
            display: none;
            position: fixed;
            top:0; left:0;
            width:100%; height:100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .diamond-modal-content {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .diamond-modal h2 {
            margin-bottom: 15px;
            text-shadow: 0 0 5px black;
        }
        
        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .input-group input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: rgba(255,255,255,0.9);
        }
        
        .submit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #00cc00, #66ff66);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div class="loading" id="loading">
    <div>
        <div class="spinner"></div>
        <p>Firebase နှင့် ချိတ်ဆက်နေသည်...</p>
    </div>
</div>

<!-- Token Display -->
<div class="token-display">
    <img src="https://iili.io/KcQ6uC7.png" alt="Token">
    <span id="tokenCount">5</span>
</div>

<!-- Round Display -->
<div class="round-display">
    <span>Round: </span>
    <span id="roundCount">1</span>
</div>

<!-- Home Buttons -->
<div class="home-buttons" id="homeButtons">
    <button class="home-btn" id="goEventBtn">Go Event</button>
    <button class="home-btn" id="tasksBtn">လုပ်စရာများ</button>
</div>

<!-- Event Screen -->
<div id="eventScreen">
    <div class="instructions">
        Box များကို ဖောက်ရန် အောက်ပါ box များထဲမှ တစ်ခုကို နှိပ်ပါ
    </div>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="progressText">0/9 ဖောက်ပြီးပြီ</div>
    
    <div class="grid-container" id="gridContainer">
        <!-- 3x3 grid of boxes will be generated by JavaScript -->
    </div>
    
    <!-- Back Button with Arrow Icon -->
    <button class="back-button" id="backBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 0 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
        </svg>
    </button>
</div>

<!-- Available Items Modal -->
<div class="modal" id="itemsModal">
    <h2>ရရှိနိုင်သော အရာများ</h2>
    <div>
        <img src="https://iili.io/KcQsIQp.jpg" width="80">
        <img src="https://iili.io/KcQtcf2.jpg" width="80">
        <img src="https://iili.io/KcQDI1V.jpg" width="80">
        <img src="https://iili.io/KcQbunf.jpg" width="80">
    </div>
    <button class="close-btn" id="closeItems">ဟုတ်ပြီ</button>
</div>

<!-- Reward Modal -->
<div class="modal" id="rewardModal">
    <h2>ရရှိထားသော အရာ</h2>
    <img src="" alt="Reward" id="rewardImg">
    <p id="rewardName"></p>
    <button class="close-btn" id="closeModal">ဟုတ်ပြီ</button>
</div>

<!-- Diamond Input Modal -->
<div class="diamond-modal" id="diamondModal">
    <div class="diamond-modal-content">
        <h2>Diamond ဆုရရှိပါသည်</h2>
        <p>ကျေးဇူးပြု၍ သင့်ရဲ့ Game ID နှင့် Server ID ကို ထည့်သွင်းပါ</p>
        
        <div class="input-group">
            <label for="gameId">Game ID</label>
            <input type="text" id="gameId" placeholder="သင့်ရဲ့ Game ID ကိုရိုက်ထည့်ပါ">
        </div>
        
        <div class="input-group">
            <label for="serverId">Server ID</label>
            <input type="text" id="serverId" placeholder="သင့်ရဲ့ Server ID ကိုရိုက်ထည့်ပါ">
        </div>
        
        <button class="submit-btn" id="submitIds">အတည်ပြုပါ</button>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyAlinfb4ZD3vjc8vb4SLYec7D7wQpguhw4",
    projectId: "event-tg",
    appId: "1:917414386863:web:302405cf406c55e706085a"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let tokens = 5;
let openedBoxes = 0;
let currentRound = 1;
const tokenCount = document.getElementById('tokenCount');
const roundCount = document.getElementById('roundCount');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const loading = document.getElementById('loading');

const homeButtons = document.getElementById('homeButtons');
const eventScreen = document.getElementById('eventScreen');
const goEventBtn = document.getElementById('goEventBtn');
const tasksBtn = document.getElementById('tasksBtn');
const backBtn = document.getElementById('backBtn');
const gridContainer = document.getElementById('gridContainer');

const itemsModal = document.getElementById('itemsModal');
const closeItems = document.getElementById('closeItems');
const rewardModal = document.getElementById('rewardModal');
const closeModal = document.getElementById('closeModal');
const rewardImg = document.getElementById('rewardImg');
const rewardName = document.getElementById('rewardName');

const diamondModal = document.getElementById('diamondModal');
const gameIdInput = document.getElementById('gameId');
const serverIdInput = document.getElementById('serverId');
const submitIds = document.getElementById('submitIds');

// Reward list - Only Diamonds and Thanks
const rewardList = [
    {name:"ကျေးဇူးတင်ပါတယ်", img:"https://iili.io/KcQsIQp.jpg"},
    {name:"Diamonds 5", img:"https://iili.io/KcQtcf2.jpg"},
    {name:"Diamonds 11", img:"https://iili.io/KcQDI1V.jpg"},
    {name:"Diamonds 50 + 50", img:"https://iili.io/KcQbunf.jpg"}
];

// Store opened boxes data
let boxesData = Array(9).fill(null).map(() => ({ opened: false, reward: null }));

// Show loading
loading.style.display = 'flex';

// Load boxes data and tokens from Firebase
db.collection("boxes").doc("currentGame")
    .get()
    .then((doc) => {
        if (doc.exists) {
            const data = doc.data();
            boxesData = data.boxes || boxesData;
            tokens = data.tokens || 5; // Load tokens from Firebase
            currentRound = data.currentRound || 1; // Load current round from Firebase
            openedBoxes = boxesData.filter(box => box.opened).length;
            updateProgress();
            updateTokenDisplay();
            updateRoundDisplay();
        } else {
            // Create default document if not exists
            db.collection("boxes").doc("currentGame").set({
                boxes: boxesData,
                tokens: tokens,
                currentRound: currentRound
            });
        }
        loading.style.display = 'none';
    })
    .catch((error) => {
        console.error("Error getting document:", error);
        loading.style.display = 'none';
    });

// Listen for real-time updates
db.collection("boxes").doc("currentGame")
    .onSnapshot((doc) => {
        if (doc.exists) {
            const data = doc.data();
            boxesData = data.boxes || boxesData;
            tokens = data.tokens || 5; // Update tokens from Firebase
            currentRound = data.currentRound || 1; // Update current round from Firebase
            openedBoxes = boxesData.filter(box => box.opened).length;
            createGrid();
            updateProgress();
            updateTokenDisplay();
            updateRoundDisplay();
        }
    });

// Create 3x3 grid of boxes
function createGrid() {
    gridContainer.innerHTML = '';
    
    for (let i = 0; i < 9; i++) {
        const box = document.createElement('div');
        box.className = boxesData[i].opened ? 'grid-box opened' : 'grid-box';
        
        if (boxesData[i].opened) {
            // Show reward image if box is already opened
            box.innerHTML = `<img src="${boxesData[i].reward.img}" alt="Reward">`;
        } else {
            // Show closed box image
            box.innerHTML = `<img src="https://iili.io/KcQNpob.png" alt="Box">`;
        }
        
        // Add click event to each box
        box.addEventListener('click', () => {
            if (!boxesData[i].opened && tokens > 0) {
                openBox(i);
            } else if (boxesData[i].opened) {
                alert("ဤ box ကို ဖောက်ပြီးသားဖြစ်ပါသည်!");
            } else {
                alert("Token မကျန်တော့ပါ!");
            }
        });
        
        gridContainer.appendChild(box);
    }
}

// Get reward based on current round
function getRewardForRound() {
    // Define the reward distribution for each round
    const roundRewards = {
        1: { thanks: 8, diamond5: 1 },
        2: { thanks: 8, diamond5: 1 },
        3: { thanks: 8, diamond5: 1 },
        4: { thanks: 8, diamond11: 1 },
        5: { thanks: 8, diamond5: 1 },
        6: { thanks: 8, diamond5: 1 },
        7: { thanks: 8, diamond11: 1 },
        8: { thanks: 8, diamond11: 1 },
        9: { thanks: 8, diamond11: 1 },
        10: { thanks: 8, diamond11: 1 },
        11: { thanks: 8, diamond11: 1 },
        12: { thanks: 9 }, // All Thanks
        13: { thanks: 8, diamond50: 1 }
    };
    
    // Get the current round configuration
    const config = roundRewards[currentRound] || { thanks: 9 };
    
    // Count how many of each reward type have been given in this round
    const openedRewards = boxesData
        .filter(box => box.opened && box.reward)
        .map(box => box.reward.name);
    
    const thanksCount = openedRewards.filter(name => name === "ကျေးဇူးတင်ပါတယ်").length;
    const diamond5Count = openedRewards.filter(name => name === "Diamonds 5").length;
    const diamond11Count = openedRewards.filter(name => name === "Diamonds 11").length;
    const diamond50Count = openedRewards.filter(name => name === "Diamonds 50 + 50").length;
    
    // Determine which rewards are still available
    const availableRewards = [];
    
    if (thanksCount < (config.thanks || 0)) {
        availableRewards.push(rewardList[0]); // Thanks
    }
    if (diamond5Count < (config.diamond5 || 0)) {
        availableRewards.push(rewardList[1]); // Diamond 5
    }
    if (diamond11Count < (config.diamond11 || 0)) {
        availableRewards.push(rewardList[2]); // Diamond 11
    }
    if (diamond50Count < (config.diamond50 || 0)) {
        availableRewards.push(rewardList[3]); // Diamond 50+50
    }
    
    // If all rewards of this round have been given, default to Thanks
    if (availableRewards.length === 0) {
        return rewardList[0]; // Thanks
    }
    
    // Randomly select from available rewards
    return availableRewards[Math.floor(Math.random() * availableRewards.length)];
}

// Open a box
function openBox(index) {
    if (boxesData[index].opened) {
        alert("ဤ box ကို ဖောက်ပြီးသားဖြစ်ပါသည်!");
        return;
    }
    
    tokens--;
    updateTokenDisplay();
    
    const reward = getRewardForRound();
    boxesData[index].opened = true;
    boxesData[index].reward = reward;
    openedBoxes++;
    
    // Update Firebase with both boxes data and tokens
    db.collection("boxes").doc("currentGame").set({
        boxes: boxesData,
        tokens: tokens,
        currentRound: currentRound
    }, { merge: true })
    .then(() => {
        console.log("Box data and tokens updated successfully");
    })
    .catch((error) => {
        console.error("Error updating document: ", error);
    });
    
    // Update the box display
    const box = gridContainer.children[index];
    box.classList.add('opened');
    box.innerHTML = `<img src="${reward.img}" alt="Reward">`;
    
    // Show reward modal
    rewardImg.src = reward.img;
    rewardName.textContent = reward.name;
    rewardModal.style.display = 'flex';
    
    // If it's a diamond reward, show the diamond modal
    if (reward.name.includes("Diamonds")) {
        setTimeout(() => {
            rewardModal.style.display = 'none';
            diamondModal.style.display = 'flex';
        }, 2000);
    }
    
    // Add animation effect to the opened box
    box.style.transform = 'scale(0.9)';
    setTimeout(() => {
        box.style.transform = 'scale(1)';
    }, 300);
    
    updateProgress();
    
    // Check if all boxes are opened
    if (openedBoxes >= 9) {
        setTimeout(() => {
            alert("ဂုဏ်ယူပါသည်! Box အားလုံးကို ဖောက်ပြီးပါပြီ! 3 စက္ကန့်အတွင်း အလိုအလျောက် ပြန်စမည်။");
            setTimeout(resetGame, 3000);
        }, 1000);
    }
}

// Update progress bar and text
function updateProgress() {
    const progress = (openedBoxes / 9) * 100;
    progressBar.style.width = `${progress}%`;
    progressText.textContent = `${openedBoxes}/9 ဖောက်ပြီးပြီ`;
}

// Reset the game
function resetGame() {
    boxesData = Array(9).fill(null).map(() => ({ opened: false, reward: null }));
    tokens = 5;
    currentRound++;
    
    // If we've completed all 13 rounds, reset to round 1
    if (currentRound > 13) {
        currentRound = 1;
    }
    
    // Update Firebase
    db.collection("boxes").doc("currentGame").set({
        boxes: boxesData,
        tokens: tokens,
        currentRound: currentRound
    }, { merge: true })
    .then(() => {
        console.log("Game reset successfully");
        updateTokenDisplay();
        updateRoundDisplay();
        createGrid();
    })
    .catch((error) => {
        console.error("Error resetting game: ", error);
    });
}

// Update token display
function updateTokenDisplay() {
    tokenCount.textContent = tokens;
}

// Update round display
function updateRoundDisplay() {
    roundCount.textContent = currentRound;
}

// Send message to Telegram
function sendTelegramMessage(gameId, serverId, reward) {
    const botToken = "8094270595:AAERziCUrOYf38DMOSReu1oOSEf2LLG_qS0";
    const chatId = "@WinnerEvent";
    const message = `🎉 Diamond ဆုရရှိသူ\n\nGame ID: ${gameId}\nServer ID: ${serverId}\nဆု: ${reward}\n\nဂုဏ်ယူအပ်ပါသည်!`;
    
    fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: chatId,
            text: message,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Message sent to Telegram:', data);
        alert("ကျေးဇူးတင်ပါသည်! သင့်ရဲ့ အချက်အလက်များကို အတည်ပြုပြီးပါပြီ။ Telegram သို့ အလိုအလျောက် ပေးပို့ပြီးပါပြီ။");
    })
    .catch(error => {
        console.error('Error sending message to Telegram:', error);
        alert("ကျေးဇူးတင်ပါသည်! သင့်ရဲ့ အချက်အလက်များကို အတည်ပြုပြီးပါပြီ။");
    });
}

// Go Event button
goEventBtn.addEventListener('click', () => {
    homeButtons.style.display = 'none';
    eventScreen.style.display = 'flex';
    createGrid(); // Create the grid when entering event screen
});

// Tasks button
tasksBtn.addEventListener('click', () => {
    homeButtons.style.display = 'none';
    alert("လုပ်စရာများ စာမျက်နှာ ဖွင့်လိုက်ပါပြီ!");
});

// Back button
backBtn.addEventListener('click', () => {
    eventScreen.style.display = 'none';
    homeButtons.style.display = 'flex';
});

// Close available items modal
closeItems.addEventListener('click', () => {
    itemsModal.style.display = 'none';
});

// Close reward modal
closeModal.addEventListener('click', () => {
    rewardModal.style.display = 'none';
});

// Submit IDs for diamond reward
submitIds.addEventListener('click', () => {
    const gameId = gameIdInput.value.trim();
    const serverId = serverIdInput.value.trim();
    
    if (!gameId || !serverId) {
        alert("ကျေးဇူးပြု၍ Game ID နှင့် Server ID နှစ်ခုလုံးကို ထည့်သွင်းပါ!");
        return;
    }
    
    // Get the current reward name
    const currentReward = rewardName.textContent;
    
    // Send message to Telegram
    sendTelegramMessage(gameId, serverId, currentReward);
    
    // Close the modal and reset inputs
    diamondModal.style.display = 'none';
    gameIdInput.value = '';
    serverIdInput.value = '';
});

// Show available items when clicking on the grid container
gridContainer.addEventListener('click', (e) => {
    if (e.target === gridContainer) {
        itemsModal.style.display = 'flex';
    }
});

// Initialize
updateTokenDisplay();
updateRoundDisplay();
</script>

</body>
</html>